<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List 2</title>
    <style>
        /* .taskBox-spanTag, */
        .taskBox-inputTag {
            /* 我想把这个input充满 */
            width: calc(100% - 280px);
            font-size: large;
        }

        .taskTrailing {
            /* float: right; */
            display: inline-block;
            font-size: small;
        }

        #sidebar {
            position: fixed;
            top: 0px;
            left: 0px;
            width: 320px;
            height: 100vh;
            border-right: 1px solid;
        }

        #right {
            padding: 0 0 0 320px;
        }

        #topBar {
            position: relative;
        }

        #topBar>* {
            display: inline;
        }

        #generalOptions {
            position: absolute;
            right: 0px;
        }

        .groupItem {
            position: relative;
        }

        .groupTrailing {
            position: absolute;
            right: 0px;
            top: 0px;
        }

        .groupItem:hover .taskNumber {
            display: none;
        }

        .groupItem:hover .groupOptions {
            display: block;
        }

        .groupOptions {
            display: none;
        }

        #allTasks .taskNumber,
        #toDeadline .taskNumber {
            display: block;
        }

        #groupList[remainingGroups="1"] .deleteGroup {
            display: none;
        }

        .taskOptions {
            display: none;
        }

        .taskItem[isFocusing="true"] .taskOptions {
            display: block;
        }

        .taskMain {
            border: 2px solid blue;
            margin-top: 1em;
        }

        .taskContent {
            border: none;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div>分组</div>
        <div id="groupList">
        </div>
        <button id="addGroup">添加分组</button>
    </div>
    <div id="right">
        <div id="topBar">
            <div></div>
            <!--当前分组的标题-->
            <div id="generalOptions">
                <button id="reset">抹掉数据</button>
                <button id="export">导出数据</button>
                <button id="import">导入数据</button>
            </div>
        </div>
        <div id="container">
        </div>
        <div>
            <!-- 底部的div，没有class, id -->
            <!-- 紧贴在所有事项的底部，末尾总是有的输入框 -->
            <input type="text" class="taskBox-inputTag" id="addNewTask">
            <div class="taskTrailing">
                <button id="addTask">添加</button>
            </div>
        </div>
    </div>
    <script>
        let storageCenter;
        function StorageCenter(obj) {
            this.userData = {
                taskItemData: [],
                groupItemData: [{ name: defaultGroupName }]
            };
            this.userStatus = {
                currentGroup: defaultGroupName,
                focusingTask: null
            };
            Object.keys(obj).map(p => this[p] = obj[p]);
        }
        StorageCenter.prototype.addTask = function (taskItemObject) {
            this.userData.taskItemData.push(taskItemObject);
        };
        StorageCenter.prototype.addGroup = function (groupItemObject) {
            this.userData.groupItemData.push(groupItemObject);
        };
        StorageCenter.prototype.deleteTask = function (timestamp) {
            let index = storageCenter.userData.taskItemData.findIndex(e => e.createdAt === timestamp);
            storageCenter.userData.taskItemData.splice(index, 1);
        };
        StorageCenter.prototype.deleteGroup = function (groupName) {
            let index = storageCenter.userData.groupItemData.findIndex(e => e.name === groupName);
            storageCenter.userData.groupItemData.splice(index, 1);
            // 删除该分组内的所有事项
            storageCenter.userData.taskItemData = storageCenter.userData.taskItemData.filter(e => e.group !== groupName);
            if (storageCenter.userStatus.currentGroup === groupName) { // 如果被删的分组是活跃分组
                if (storageCenter.userData.groupItemData[index] !== undefined) { // 此时 index 指向被删的下一个元素，如果没有越界
                    storageCenter.userStatus.currentGroup = storageCenter.userData.groupItemData[index].name;
                }
                else { // 如果越界，即活跃分组变为上一分组
                    storageCenter.userStatus.currentGroup = storageCenter.userData.groupItemData[index - 1].name;
                }
            }
        };
        StorageCenter.prototype.renameGroup = function (oldName, newName) {
            // 修改分组对象的 name
            storageCenter.findGroupItemObject(oldName).name = newName;
            for (taskItem of storageCenter.userData.taskItemData) {
                if (taskItem.group === oldName) {
                    taskItem.group = newName;
                }
            }
            // 如果重命名的分组是活跃的分组
            if (oldName === storageCenter.userStatus.currentGroup) {
                storageCenter.userStatus.currentGroup = newName;
            }
        };
        StorageCenter.prototype.findTaskItemObject = function (timestamp) {
            for (taskItem of this.userData.taskItemData) {
                if (taskItem.createdAt === timestamp) {
                    return taskItem;
                }
            }
        };
        StorageCenter.prototype.findGroupItemObject = function (groupName) {
            for (groupItem of this.userData.groupItemData) {
                if (groupName === groupItem.name) {
                    return groupItem;
                }
            }
        };
        StorageCenter.prototype.focusOnTask = function (taskItemNode) {
            let timestamp = Number(taskItemNode.getAttribute('timestamp'));
            storageCenter.userStatus.focusingTask = timestamp;
            taskItemNode.setAttribute('isFocusing', 'true');
        }
        function pauseToLocalStorage() {
            localStorage.setItem('pausedData', JSON.stringify(storageCenter));
        }
        function resumeFromLocalStorage() {
            storageCenter = new StorageCenter(JSON.parse(localStorage.getItem('pausedData')));
        }
        function TaskItem(data) {
            // 事项对象的默认 property
            this.text = '空事项';
            this.isDone = false;
            this.createdAt = new Date().getTime();
            this.group = storageCenter.userStatus.currentGroup;
            this.deadline = null;
            Object.keys(data).map(p => this[p] = data[p]);
        }
        function GroupItem(data) {
            // 分组对象的默认 property
            this.name = '未命名分组';
            Object.keys(data).map(p => this[p] = data[p]);
        }
        function UserStatus(obj) {
            // 用户状态对象的默认 property
            this.currentGroup = null;
            Object.keys(obj).map(p => this[p] = obj[p]);
        }
        // refresh UI
        function refreshBody() {
            refreshGroupList();
            refreshTaskContainer();
            refreshCurrentGroupName();
        }
        function refreshGroupList() {
            // 先清空
            let groupListElement = document.getElementById('groupList');
            groupListElement.innerHTML = '';
            let e = document.createElement('div');
            e.innerHTML = `
        <div>
            <div class="groupItem" id="allTasks">
                <div class="groupName">全部事项</div>
                <div class="groupTrailing">
                    <div class="taskNumber">${storageCenter.userData.taskItemData.length}</div>
                </div>
            </div>
            <div class="groupItem" id="toDeadline">
                <div class="groupName">将要截止</div>
                <div class="groupTrailing">
                    <div class="taskNumber">${storageCenter.userData.taskItemData.filter(e => e.deadline).length}</div>
                </div>
            </div>
        </div>
            `
            groupListElement.appendChild(e.getElementsByTagName('div')[0]); // 以后优化一下怎么从 HTML字符串创建元素，这行代码导致多了一个空的 div
            storageCenter.userData.groupItemData.forEach(e => groupListElement.appendChild(createElement_groupItem(new GroupItem(e))));
            document.getElementById('groupList').setAttribute('remainingGroups', storageCenter.userData.groupItemData.length);
        }
        function refreshTaskContainer() {
            let taskContainer = document.getElementById('container');
            // 先清空
            taskContainer.innerHTML = '';
            let currentGroup = storageCenter.userStatus.currentGroup;
            switch (currentGroup) {
                case virtualGroupName:
                    storageCenter.userData.taskItemData.forEach(e => taskContainer.appendChild(createElement_taskItem(new TaskItem(e))));
                    break;
                case '将要截止':
                    let taskItemsWithDeadline = storageCenter.userData.taskItemData.filter(e => e.deadline);
                    let sorted = taskItemsWithDeadline.sort((a, b) => a.deadline - b.deadline);
                    sorted.forEach(e => taskContainer.appendChild(createElement_taskItem(new TaskItem(e))));
                    break;
                default:
                    for (taskItem of storageCenter.userData.taskItemData) {
                        if (taskItem.group === currentGroup) {
                            taskContainer.appendChild(createElement_taskItem(new TaskItem(taskItem)));
                        }
                    }
                    break;
            }
        }
        function refreshCurrentGroupName() {
            document.querySelector('#topBar > div').textContent = storageCenter.userStatus.currentGroup;
        }
        const defaultGroupName = '默认分组';
        const virtualGroupName = '全部事项';
        // 业务：全新启动
        window.addEventListener('load', function () {
            if (localStorage.getItem('pausedData') === null || localStorage.getItem('pausedData') === '{}') { // 用 beforeunload 事件，仅在退出网页时备份；且全新启动的判断由 == null 换成了 == {}
                storageCenter = new StorageCenter({});
                refreshBody();
            }
            else {
                resumeFromLocalStorage();
                refreshBody();
            }
        })
        // 业务：关闭网页
        window.addEventListener('pagehide', function () {
            pauseToLocalStorage();
        });
        // 听说这是公交车？
        document.body.addEventListener('click', function (event) {
            if (event.target.id === 'reset') {
                localStorage.clear();
                storageCenter = {};
                location.reload();
            }
            if (event.target.id === 'addTask') {
                let userInput = document.getElementById('addNewTask').value;
                if (userInput !== '') {
                    let newTaskItem = new TaskItem({ text: userInput }); // 构造新任务的对象
                    if (storageCenter.userStatus.currentGroup === virtualGroupName) { // 如果活跃分组是虚拟分组「全部事项」
                        newTaskItem.group = storageCenter.userData.groupItemData[0].name; // 则新任务对象的分组property变为第一个分组
                    }
                    storageCenter.addTask(newTaskItem);
                    refreshBody();
                }
                document.getElementById('addNewTask').value = '';
            }
            if (event.target.id === 'addGroup') {
                let userInput = prompt('请输入新分组的名称');
                let flag = true; // 很C语言
                if (userInput !== null) { // 用户没点「取消」
                    if (userInput !== '') {
                        for (groupItem of storageCenter.userData.groupItemData) {
                            if (groupItem.name === userInput) {
                                flag = false;
                                alert('已有名为' + userInput + '的分组');
                                break; // 很C语言
                            }
                        }
                        if (flag) { // 很C语言
                            storageCenter.addGroup(new GroupItem({ name: userInput }));
                            refreshGroupList();
                        }
                    }
                    else { alert('分组名称不能为空') }
                }
            }
            if (event.target.classList.contains('deleteTask')) {
                let taskItemNode = event.target.closest('.taskItem');
                let timestamp = Number(taskItemNode.getAttribute('timestamp'));
                storageCenter.deleteTask(timestamp);
                storageCenter.userStatus.focusingTask = null;
                refreshTaskContainer();
                refreshGroupList();
            }
            if (event.target.classList.contains('editGroup')) {
                let userInput = prompt('请输入新的分组名称');
                let flag = true; // 很C语言
                if (userInput !== null) { // 用户没点「取消」
                    if (userInput !== '') {
                        for (groupItem of storageCenter.userData.groupItemData) {
                            if (groupItem.name === userInput) {
                                flag = false;
                                alert('已有名为' + userInput + '的分组');
                                break; // 很C语言
                            }
                        }
                        if (flag) { // 很C语言
                            let groupItemNode = event.target.closest('.groupItem');
                            let oldName = groupItemNode.getAttribute('groupName');
                            storageCenter.renameGroup(oldName, userInput);
                            refreshGroupList();
                            refreshCurrentGroupName();
                        }
                    }
                    else { alert('分组名称不能为空') }
                }
            }
            if (event.target.classList.contains('deleteGroup')) {
                let groupItemNode = event.target.closest('.groupItem');
                let groupName = groupItemNode.getAttribute('groupName');
                let number = storageCenter.userData.taskItemData.filter(e => e.group === groupName).length;
                if (confirm(`确认删除${groupName}分组？这将会删除该分组中共计${number}个事项。`)) {
                    storageCenter.deleteGroup(groupName);
                    refreshBody();
                }
            }
            if (event.target.classList.contains('isDone')) {
                let taskItemNode = event.target.closest('.taskItem');
                let timestamp = Number(taskItemNode.getAttribute('timestamp'));
                let taskItem = storageCenter.findTaskItemObject(timestamp);
                taskItem.isDone ? taskItem.isDone = false : taskItem.isDone = true;
                refreshTaskContainer();
            }
            if (event.target.classList.contains('groupName')) {
                storageCenter.userStatus.currentGroup = event.target.textContent;
                storageCenter.userStatus.focusingTask = null;
                refreshCurrentGroupName();
                refreshTaskContainer();
            }
            if (event.target.id === 'export') {
                prompt('', JSON.stringify(storageCenter.userData));
            }
            if (event.target.id === 'import') {
                if (confirm('确定导入数据？警告：这会覆盖当前已有的数据。')) {
                    try {
                        let imported = JSON.parse(prompt());
                        if (imported !== null) { // 用户没点「取消」
                            storageCenter = new StorageCenter({ userData: imported });
                            storageCenter.userStatus.currentGroup = imported.groupItemData[0].name;
                            refreshBody();
                        }
                    }
                    catch (e) {
                        alert('输入格式不正确，请检查确认后重试');
                    }
                }
            }
            if (event.target.closest('.taskItem') === null && document.querySelector('.taskItem[isFocusing="true"]')) { // 点击当前聚焦的任务之外的地方则关闭 taskOptions
                storageCenter.userStatus.focusingTask = null;
                document.querySelector('.taskItem[isFocusing="true"]').setAttribute('isFocusing', 'false');
            }
            if (event.target.classList.contains('setDeadline')) {
                let taskItemNode = event.target.closest('.taskItem');
                let timestamp = Number(taskItemNode.getAttribute('timestamp'));
                let taskItem = storageCenter.findTaskItemObject(timestamp);
                taskItem.deadline === null ? taskItem.deadline = '' : taskItem.deadline = null;
                refreshTaskContainer(); // 以后改写为只刷新 taskDetails，即把 taskDetails Div 从 createElement_taskItem 中拆出来
            }
        })
        // 画 HTML 元素
        function createElement_taskItem(taskItemObject) {
            let e = document.createElement('div');
            e.innerHTML = `
            <div class="taskItem" isFocusing="${storageCenter.userStatus.focusingTask === taskItemObject.createdAt ? 'true' : 'false'}" group="${taskItemObject.group}" timestamp="${taskItemObject.createdAt}" isDone="${taskItemObject.isDone}" deadline="${taskItemObject.deadline}">
            <div class="taskMain">
                <div class="taskBox">
                <input type="checkbox" class="isDone">
            <input class="taskBox-inputTag taskContent" type="text" value="${taskItemObject.text}">
            </div>
            <div class="taskDetails">
            </div>
            </div>

        <div class="taskOptions">
            <input type="checkbox" class="setDeadline">截止日期
            <input type="checkbox" class="setNote">备注
            分组：<select class="selectGroup"></select>
            <button class="deleteTask">删除</button>
        </div>

            </div>
            `;
            e.querySelector('.isDone').checked = taskItemObject.isDone ? true : false;
            let taskDetails = e.querySelector('.taskDetails');
            // 未来优化一下，抽出 taskDetails 的画 UI 过程
            if (taskItemObject.deadline !== null) { // 如果有截止日期数据
                e.querySelector('.setDeadline').checked = true;
                taskDetails.innerHTML += '<input type="datetime-local" class="deadline">';
                taskDetails.querySelector('.deadline').addEventListener('blur', function () {
                    let taskItemNode = event.target.closest('.taskItem');
                    let timestamp = Number(taskItemNode.getAttribute('timestamp'));
                    storageCenter.findTaskItemObject(Number(timestamp)).deadline = new Date(event.target.value + ':00.000Z').getTime(); // 转换为Unix时间戳放入存储中心，使用 UTC+0 时间
                    refreshGroupList();
                });
                if (taskItemObject.deadline !== '' && isNaN(taskItemObject.deadline) === false) { // 如果截止日期不为空
                    console.log(taskItemObject)
                    console.log(taskItemObject.deadline !== NaN)
                    taskDetails.querySelector('.deadline').value = new Date(taskItemObject.deadline).toISOString().slice(0, 16);
                } // 将时间戳转换为 datetime-local 可接受的格式
            }
            else {
                e.querySelector('.setDeadline').checked = false;
            }
            e.querySelector('.taskContent').addEventListener('focus', function (event) {
                let taskItemNode = event.target.closest('.taskItem');
                let timestamp = Number(taskItemNode.getAttribute('timestamp'));
                if (storageCenter.userStatus.focusingTask) { // 如果有任务处于焦点中
                    if (taskItemNode.getAttribute('isFocusing') === 'false') { // 如果鼠标点到的任务不是聚焦的任务
                        document.querySelector('.taskItem[isFocusing="true"]').setAttribute('isFocusing', 'false');
                        storageCenter.focusOnTask(taskItemNode);
                    }
                }
                else {
                    storageCenter.focusOnTask(taskItemNode);
                }
            });
            e.querySelector('.taskContent').addEventListener('blur', function (event) {
                if (event.target.value == "") {
                    event.target.value = "空事项"
                }
                let taskItemNode = event.target.closest('.taskItem');
                let timestamp = Number(taskItemNode.getAttribute('timestamp'));
                storageCenter.findTaskItemObject(Number(timestamp)).text = event.target.value;
            })
            return e.getElementsByTagName('div')[0]; // 相当于返回上面的字符串（要保证字符串中的顶层元素只有一个）
        }
        function createElement_groupItem(groupItemObject) {
            function insideTaskNumber() {
                return storageCenter.userData.taskItemData.filter(e => e.group === groupItemObject.name).length
            }
            let e = document.createElement('div');
            e.innerHTML = `
            <div class="groupItem" groupName="${groupItemObject.name}">
            <div class="groupName">${groupItemObject.name}</div>
            <div class="groupTrailing">
                <div class="groupOptions">
                    <button class="editGroup">编辑</button>
                    <button class="deleteGroup">删除</button>
                </div>
                <div class="taskNumber">${insideTaskNumber()}</div>
            </div>
            </div>
            `
            return e.getElementsByTagName('div')[0]; // 相当于返回上面的字符串（要保证字符串中的顶层元素只有一个）
        }
    </script>
</body>

</html>